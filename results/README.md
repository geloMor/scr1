#### Выполнил: студент группы P41193 Морозов Олег Владиславович.

# Лабораторная работа №2. SCR1

Вар. | Вид исключения | Тест | Reset Vector | Trap Vector | При обработке
---- | -------------- | ---- | ------------ | ----------- | ------------- 
3 | Environment call from M-mode | isa/rv32mi/scall.S | 0x600 | 0x400 | Вывод строки «ecall»

### Цель:
Ознакомиться с возможностями настройки архитектуры системы команд, обработкой исключений/прерываний и принципами работы сборщика программ.

### Выполнение:

**Примечание**: Для содержательной части отчета рекомендуется сразу перейти к пункту **3. Успешный запуск тестов**. В пункте 2 описан важный и безусловно полезный опыт обращения с программным обеспечением, который, впрочем, имеет опосредованное отношение к выполнению лабораторной работы.

1. Был создан репозиторий проекта, при помощи браузерного интерфейса github в него копирована master-ветка проекта scr1. Создана ветка lab_scr1_sim.
1. Загрузка тестов:
   1. Был скачан проект, RISCV GCC скачан с сайта Syntacore, RISC-V ISA, RISC-V Compliance и Coremark тесты.
   1. При помощи графического интерфейса Windows в переменную среды PATH была добавлена ссылка на исполняемые файлы gcc, добавлены в явном виде (внесены в таблицу, так что они сохраняются при перезапуске системы) переменные среды RISCV_TESTS и RISCV_COMPLIANCE_TESTS.
      * При запуске из командной строки start-sh.cmd команды `make run_modelsim` была получена ошибка. При наборе команды `make clean` была получена та же ошибка.
   1. Папки с RISCV GCC, RISC-V ISA, RISC-V Compliance перемещены в корневую директорию проекта scr1. Ошибка при запуске тестов повторилась.
   1. В путях, указанных в значении переменных среды символ "\" был заменён на "/". Ошибка при запуске тестов повторилась.
   1. Переменные среды были прописаны при помощи команды export. Ошибка при запуске тестов повторилась. Удаление переменных среды из таблицы и повторное задание их уже при помощи команды export не решило проблему. Повторная замена символов "\" на "/" также не дала результата.
   1. Была установлена пробная версия виртуальной машины VMware, в ней установлена система Ubuntu 20.04. Установлена последняя версия Verilator. Ошибка при запуске тестов повторилась.
   1. Была произведена сборка Verilator с git для версии 4.012. Тем не менее, ошибка при запуске тестов повторилась.
   1. При помощи команды `sudo ln -s /usr/lib/x86_64-linux-gnu/libmpfr.so.6 /usr/lib/x86_64-linux-gnu/libmpfr.so.4` проблему удалось решить.
1. **Успешный запуск тестов**:
   * Тесты успешно прошли при запуске в терминале Ubuntu на версии Verilator 4.012 при создании ссылки на файл `libmpfr.so.6` вида `/usr/lib/x86_64-linux-gnu/libmpfr.so.4`. Запуск производился в конфигурации по умолчанию при помощи команды `make run_verilator`.
1. В файле `./src/includes/scr1_arch_description.svh` параметр SCR1_TRACE_LOG_FULL был помещён в комментарии.
   * На этом этапе был произведён первый значительный коммит проекта "plus_tests".
1. Для того, чтобы при симуляции запускался лишь тест, указанный в задании были изменены два файла:
   * в .Makefile закоменнтированые все тесты в строказ с 85 по 100 кроме строки `TARGETS += riscv_isa`.
   * В файле `scr1/sim/tests/riscv_isa/rv32_tests.inc` строки с 5 по 63 были заменены на `rv32_isa_tests += isa/rv32mi/scall.S`.
1. Симуляция была запущена заново, теперь тест исполняется лишь один, указанный в задании.
1. В файле `./sim/tests/common/riscv_macros.h` была модифицирована обработка исключений trap_vector. Добавлена проверка исключения "Environment call from M-mode" CAUSE_MACHINE_ECALL (строка 113). Прочие виды исключений типа Ecall были убраны.
1. Для вывода строки "ecall" в консоль изменён файл `scr1/src/tb/scr1_top_tb_ahb.sv` в строке 316: текст с `\033[0;32mTest passed\033[0m\n` был заменён на `\033[0;32mECALL\033[0m\n`.
1. В файле `./src/includes/scr1_arch_description.svh`в строках 130 и 131 значения параметров SCR1_ARCH_RST_VECTOR и изменены на 'h600 и 'h400 соответственно.
1. В файле `./sim/tests/common/link.ld` в строке 29 значение адреса изменено с 0x100 на 0x200;
   * На этом этапе был произведён второй значительный коммит проекта "with edition".
1. В корневой директории проекта создана директория results с файлами test_results.txt (результат симуляции), *.dump (дизассемблер теста ), trace_mprf_diff_.log (трейс лог MPRF), trace_csr_.lo (трейс лог CSR) и README.md для составления отчета.
   * На этом этапе был произведён третий значительный коммит проекта "results".
1. В файле README.md был составлен отчёт.

### Выводы:
1. В ходе данной работы *пришлось* освоить основы работы с git и Ubuntu на Virtual machine.
  1. Симуляцию на Win10 при помощи ModelSim запустить не удалось.
1. Симуляция происходит в Verilator в ходе выполнения программы на System Verilog. Тесты на C и RISCV ассемблере компилируются при помощи gcc в hex представление и загружаются на исполнение в .sv testbench.

### Примечания:
 * В пункте задания `5. Дополнительная информация` в ссылках 
 ```GNU make версии 4.0 или выше https://www.gnu.org/software/make/, (Ссылки на внешний сайт.)
 Открытый симулятор Verilator версии 4.0 или выше https://www.veripool.org/wiki/verilator,
 ```
 запятые читаются как часть ссылки, из-за чего сами ссылки работаю некорректно.
* На Github не были загружены три файла по причине их большого размера, они были добавлены в .gitignore:
```
riscv-unknown-elf-gcc/libexec/gcc/riscv64-unknown-elf/7.1.1/cc1
riscv-unknown-elf-gcc/libexec/gcc/riscv64-unknown-elf/7.1.1/cc1plus
riscv-unknown-elf-gcc/libexec/gcc/riscv64-unknown-elf/7.1.1/lto1
```
